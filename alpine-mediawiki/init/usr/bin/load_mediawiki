#!/bin/sh

MEDIAWIKI_VERSION="1.27"
MEDIAWIKI_FILE="mediawiki-1.27.1"
VISUAL_EDITOR="VisualEditor-REL1_27-9da5996"

# download
curl -sSL https://releases.wikimedia.org/mediawiki/${MEDIAWIKI_VERSION}/${MEDIAWIKI_FILE}.tar.gz | tar xz -C /tmp
mkdir /www
mv /tmp/${MEDIAWIKI_FILE}/ /www/mediawiki


# download extensions
curl -sSL https://extdist.wmflabs.org/dist/extensions/${VISUAL_EDITOR}.tar.gz | tar xz -C /www/mediawiki/extensions


# clear
rm -rf /www/mediawiki/tests
rm -rf /www/mediawiki/docs
rm -rf /www/mediawiki/cache
rm -rf /www/mediawiki/extensions/Cite
rm -rf /www/mediawiki/extensions/CiteThisPage
rm -rf /www/mediawiki/extensions/ConfirmEdit
rm -rf /www/mediawiki/extensions/Gadgets
rm -rf /www/mediawiki/extensions/ImageMap
rm -rf /www/mediawiki/extensions/Interwiki
rm -rf /www/mediawiki/extensions/LocalisationUpdate
rm -rf /www/mediawiki/extensions/Nuke
rm -rf /www/mediawiki/extensions/ParserFunctions
rm -rf /www/mediawiki/extensions/PdfHandler
rm -rf /www/mediawiki/extensions/Poem
rm -rf /www/mediawiki/extensions/Renameuser
rm -rf /www/mediawiki/extensions/SpamBlacklist
rm -rf /www/mediawiki/extensions/TitleBlacklist
find /www/mediawiki/ -type f -regex ".*/\(HISTORY\|LICENSE\|RELEASE-NOTES\|README\|INSTALL\|Changelog\|History\|CREDITS\|FAQ\)" -delete
find /www/mediawiki/languages/i18n/ -type f ! -regex ".*/\(en.json\|ru.json\)" -delete
find /www/mediawiki/languages/messages/ -type f ! -regex ".*/\(MessagesEn.php\|MessagesRu.php\)" -delete


# set right
chown -R nobody:www-data /www
chmod -R 644 /www
find /www -type d -exec chmod 0755 "{}" +
find /www -name \*.php -exec chown nobody:nobody "{}" +


# extensions
mkdir -p /origin
mv /www/mediawiki/extensions /origin/extensions
ln -s /data/extensions /www/mediawiki/extensions
ln -s /data/settings.php /www/mediawiki/settings.php